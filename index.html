<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>カラオケ予約システム</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="app"></div>
  
  <script>
    // Simple icon components as SVG strings
    const icons = {
      music: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/></svg>',
      users: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>',
      plus: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>',
      x: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>',
      check: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>',
      trash: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>',
      copy: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>',
      arrowRight: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/></svg>',
      login: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"/></svg>'
    };

    // State management
    let state = {
      roomCode: '',
      roomTitle: '',
      isInRoom: false,
      showJoinScreen: false,
      members: [],
      songs: [],
      showAddMember: false,
      showCopyNotice: false
    };

    // Storage helpers
    const storage = {
      get: (key) => {
        const value = localStorage.getItem(key);
        return value ? JSON.parse(value) : null;
      },
      set: (key, value) => {
        localStorage.setItem(key, JSON.stringify(value));
      }
    };

    // Generate random room code
    function generateRoomCode() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let code = '';
      for (let i = 0; i < 6; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return code;
    }

    // Load room data
    function loadRoomData(code) {
      const title = storage.get(`room-${code}-title`);
      if (!title) {
        alert('ルームコードが見つかりません');
        return false;
      }
      state.roomTitle = title;
      state.members = storage.get(`room-${code}-members`) || [];
      state.songs = storage.get(`room-${code}-songs`) || [];
      return true;
    }

    // Save data
    function saveMembers() {
      storage.set(`room-${state.roomCode}-members`, state.members);
    }

    function saveSongs() {
      storage.set(`room-${state.roomCode}-songs`, state.songs);
    }

    // Sort songs by votes
    function sortSongs() {
      state.songs.sort((a, b) => b.votes.length - a.votes.length);
    }

    // Create room
    function createRoom() {
      const title = document.getElementById('newRoomTitle').value.trim();
      if (!title) {
        alert('タイトルを入力してください');
        return;
      }
      const code = generateRoomCode();
      state.roomCode = code;
      state.roomTitle = title;
      storage.set(`room-${code}-title`, title);
      state.isInRoom = true;
      render();
    }

    // Join room
    function joinRoom() {
      const code = document.getElementById('joinCode').value.trim().toUpperCase();
      if (!code) {
        alert('ルームコードを入力してください');
        return;
      }
      if (loadRoomData(code)) {
        state.roomCode = code;
        state.isInRoom = true;
        state.showJoinScreen = false;
        render();
      }
    }

    // Add member
    function addMember() {
      const name = document.getElementById('newMemberName').value.trim();
      if (!name) return;
      if (state.members.includes(name)) {
        alert('この名前はすでに登録されています');
        return;
      }
      state.members.push(name);
      saveMembers();
      document.getElementById('newMemberName').value = '';
      state.showAddMember = false;
      render();
    }

    // Remove member with confirmation
    function confirmRemoveMember(name) {
      if (confirm(`${name}さんを削除してもよろしいですか？`)) {
        state.members = state.members.filter(m => m !== name);
        saveMembers();
        state.songs = state.songs.map(song => ({
          ...song,
          votes: song.votes.filter(v => v !== name)
        })).filter(song => song.addedBy !== name);
        saveSongs();
        render();
      }
    }

    // Add song
    function addSong() {
      const title = document.getElementById('newSong').value.trim();
      const adder = document.getElementById('selectedAdder').value;
      if (!title || !adder) {
        alert('曲名と追加者を選択してください');
        return;
      }
      state.songs.push({
        id: Date.now(),
        title: title,
        addedBy: adder,
        votes: [adder]
      });
      sortSongs();
      saveSongs();
      document.getElementById('newSong').value = '';
      document.getElementById('selectedAdder').value = '';
      render();
    }

    // Toggle vote
    function toggleVote(songId) {
      const voter = prompt('投票する人の名前を選択してください\n\n' + state.members.join('\n'));
      if (!voter || !state.members.includes(voter)) return;
      
      state.songs = state.songs.map(song => {
        if (song.id === songId) {
          const hasVoted = song.votes.includes(voter);
          return {
            ...song,
            votes: hasVoted 
              ? song.votes.filter(v => v !== voter)
              : [...song.votes, voter]
          };
        }
        return song;
      });
      sortSongs();
      saveSongs();
      render();
    }

    // Delete song
    function deleteSong(songId) {
      if (confirm('この曲を削除してもよろしいですか？')) {
        state.songs = state.songs.filter(s => s.id !== songId);
        saveSongs();
        render();
      }
    }

    // Complete song
    function completeSong(songId) {
      if (confirm('この曲を完了してもよろしいですか？')) {
        state.songs = state.songs.filter(s => s.id !== songId);
        saveSongs();
        render();
      }
    }

    // Copy room code
    function copyRoomCode() {
      navigator.clipboard.writeText(state.roomCode);
      state.showCopyNotice = true;
      render();
      setTimeout(() => {
        state.showCopyNotice = false;
        render();
      }, 2000);
    }

    // Render functions
    function render() {
      const app = document.getElementById('app');
      
      if (state.showJoinScreen) {
        app.innerHTML = renderJoinScreen();
      } else if (!state.isInRoom) {
        app.innerHTML = renderCreateScreen();
      } else {
        app.innerHTML = renderMainScreen();
      }
    }

    function renderJoinScreen() {
      return `
        <div class="min-h-screen bg-gradient-to-br from-purple-600 to-blue-600 flex items-center justify-center p-4">
          <div class="bg-white rounded-lg shadow-2xl p-8 max-w-md w-full">
            <div class="text-center mb-8">
              <div class="w-20 h-20 mx-auto text-purple-600 mb-4">${icons.login}</div>
              <h1 class="text-3xl font-bold text-gray-800 mb-2">ルームに参加</h1>
              <p class="text-gray-600">6桁のルームコードを入力してください</p>
            </div>
            <div class="space-y-4">
              <input
                type="text"
                id="joinCode"
                placeholder="例: ABC123"
                maxlength="6"
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-500 text-center text-2xl font-bold tracking-wider uppercase"
              />
              <button
                onclick="joinRoom()"
                class="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition"
              >
                参加する
              </button>
              <button
                onclick="state.showJoinScreen = false; render()"
                class="w-full bg-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-400 transition"
              >
                戻る
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderCreateScreen() {
      return `
        <div class="min-h-screen bg-gradient-to-br from-purple-600 to-blue-600 flex items-center justify-center p-4">
          <div class="bg-white rounded-lg shadow-2xl p-8 max-w-md w-full">
            <div class="text-center mb-8">
              <div class="w-20 h-20 mx-auto text-purple-600 mb-4">${icons.music}</div>
              <h1 class="text-3xl font-bold text-gray-800 mb-2">カラオケ予約システム</h1>
              <p class="text-gray-600">新しいセッションを作成または参加</p>
            </div>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">セッションタイトル</label>
                <input
                  type="text"
                  id="newRoomTitle"
                  placeholder="例: 忘年会カラオケ"
                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-500"
                />
              </div>
              <button
                onclick="createRoom()"
                class="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition"
              >
                新規作成
              </button>
              <div class="relative">
                <div class="absolute inset-0 flex items-center">
                  <div class="w-full border-t border-gray-300"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                  <span class="px-2 bg-white text-gray-500">または</span>
                </div>
              </div>
              <button
                onclick="state.showJoinScreen = true; render()"
                class="w-full bg-gray-600 text-white py-3 rounded-lg font-semibold hover:bg-gray-700 transition"
              >
                既存のルームに参加
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderMainScreen() {
      return `
        <div class="min-h-screen bg-gradient-to-br from-purple-600 to-blue-600 p-4">
          <div class="max-w-4xl mx-auto">
            <div class="bg-white rounded-lg shadow-2xl overflow-hidden">
              <div class="bg-purple-600 text-white p-6">
                <div class="flex items-center justify-between mb-4">
                  <div class="flex items-center gap-3">
                    <div class="w-8 h-8">${icons.music}</div>
                    <div>
                      <h1 class="text-2xl font-bold">${state.roomTitle}</h1>
                      <p class="text-purple-200 text-sm">ルームコード: ${state.roomCode}</p>
                    </div>
                  </div>
                  <div class="flex gap-2">
                    <button
                      onclick="copyRoomCode()"
                      class="bg-purple-700 hover:bg-purple-800 px-4 py-2 rounded-lg font-semibold transition"
                    >
                      ${state.showCopyNotice ? 'コピーしました！' : 'コード共有'}
                    </button>
                    <button
                      onclick="state.isInRoom = false; state.roomCode = ''; state.members = []; state.songs = []; render()"
                      class="bg-purple-700 hover:bg-purple-800 px-4 py-2 rounded-lg font-semibold transition"
                    >
                      退出
                    </button>
                  </div>
                </div>

                <div class="mb-6">
                  <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-2">
                      <div class="w-5 h-5">${icons.users}</div>
                      <span class="font-semibold">参加メンバー (${state.members.length})</span>
                    </div>
                    <button
                      onclick="state.showAddMember = !state.showAddMember; render()"
                      class="bg-purple-700 hover:bg-purple-800 px-3 py-1 rounded-lg text-sm font-semibold transition"
                    >
                      追加
                    </button>
                  </div>

                  ${state.showAddMember ? `
                    <div class="flex gap-2 mb-3">
                      <input
                        type="text"
                        id="newMemberName"
                        placeholder="メンバー名"
                        class="flex-1 px-3 py-2 rounded-lg text-gray-800 text-sm focus:outline-none"
                      />
                      <button
                        onclick="addMember()"
                        class="bg-white text-purple-600 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-purple-50 transition"
                      >
                        追加
                      </button>
                    </div>
                  ` : ''}

                  <div class="flex flex-wrap gap-2">
                    ${state.members.length === 0 
                      ? '<p class="text-purple-200 text-sm">まだメンバーが登録されていません</p>'
                      : state.members.map(member => `
                          <div class="bg-purple-700 px-3 py-1 rounded-full text-sm flex items-center gap-2">
                            <span>${member}</span>
                            <button
                              onclick="confirmRemoveMember('${member}')"
                              class="hover:bg-purple-800 rounded-full p-0.5"
                            >
                              <div class="w-3 h-3">${icons.x}</div>
                            </button>
                          </div>
                        `).join('')
                    }
                  </div>
                </div>

                <div class="space-y-2">
                  <input
                    type="text"
                    id="newSong"
                    placeholder="曲名を入力"
                    class="w-full px-4 py-3 rounded-lg text-gray-800 focus:outline-none"
                  />
                  <div class="flex gap-2">
                    <select
                      id="selectedAdder"
                      class="flex-1 px-4 py-3 rounded-lg text-gray-800 focus:outline-none"
                      ${state.members.length === 0 ? 'disabled' : ''}
                    >
                      <option value="">追加する人を選択</option>
                      ${state.members.map(m => `<option value="${m}">${m}</option>`).join('')}
                    </select>
                    <button
                      onclick="addSong()"
                      ${state.members.length === 0 ? 'disabled' : ''}
                      class="bg-white text-purple-600 px-6 py-3 rounded-lg font-semibold hover:bg-purple-50 transition disabled:bg-gray-300 disabled:text-gray-500"
                    >
                      追加
                    </button>
                  </div>
                </div>
              </div>

              <div class="p-6">
                ${state.songs.length === 0 ? `
                  <div class="text-center py-12 text-gray-500">
                    <div class="w-16 h-16 mx-auto mb-4 opacity-50">${icons.music}</div>
                    <p class="text-lg">まだ曲が追加されていません</p>
                    <p class="text-sm">最初の曲を追加してみましょう！</p>
                  </div>
                ` : `
                  <div class="space-y-3">
                    ${state.songs.map((song, index) => `
                      <div class="bg-gray-50 rounded-lg p-4 hover:bg-gray-100 transition">
                        <div class="flex items-center justify-between">
                          <div class="flex-1">
                            <div class="flex items-center gap-3">
                              <span class="bg-purple-600 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">
                                ${index + 1}
                              </span>
                              <div>
                                <h3 class="font-bold text-lg text-gray-800">${song.title}</h3>
                                <p class="text-sm text-gray-600">追加: ${song.addedBy}</p>
                                ${song.votes.length > 0 ? `
                                  <p class="text-xs text-purple-600 mt-1">歌いたい: ${song.votes.join(', ')}</p>
                                ` : ''}
                              </div>
                            </div>
                          </div>
                          <div class="flex items-center gap-2">
                            <button
                              onclick="toggleVote(${song.id})"
                              class="px-4 py-2 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition"
                            >
                              ${song.votes.length}
                            </button>
                            <button
                              onclick="completeSong(${song.id})"
                              class="p-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition"
                              title="完了"
                            >
                              <div class="w-5 h-5">${icons.check}</div>
                            </button>
                            <button
                              onclick="deleteSong(${song.id})"
                              class="p-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition"
                              title="削除"
                            >
                              <div class="w-5 h-5">${icons.trash}</div>
                            </button>
                          </div>
                        </div>
                      </div>
                    `).join('')}
                  </div>
                `}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Initial render
    render();
  </script>
</body>
</html>
